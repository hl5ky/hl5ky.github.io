<!DOCType HTML>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:fb="http://ogp.me/ns/fb#" manifest="cache.manifest">
<head>
<meta http-equiv="content-type" content="text/html;charset=UTF-8" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="viewport" content="width=device-width" />
<title>A special course for DS5TUK</title>
<link rel='stylesheet' href='https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.8/codemirror.css'>
<script>
window.console = window.console || function(t) {};
</script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.8/codemirror.js'></script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.8/mode/xml/xml.js'></script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.8/addon/selection/mark-selection.js'></script>
<script type="text/javascript">
/*! hangul-js 2019-12-10 */
!function(){"use strict";var r,d,g,l,t,e,h=["ㄱ",["ㄱ","ㄱ"],"ㄴ","ㄷ",["ㄷ","ㄷ"],"ㄹ","ㅁ","ㅂ",["ㅂ","ㅂ"],"ㅅ",["ㅅ","ㅅ"],"ㅇ","ㅈ",["ㅈ","ㅈ"],"ㅊ","ㅋ","ㅌ","ㅍ","ㅎ"],p=["ㅏ","ㅐ","ㅑ",["ㅑ","ㅣ"],"ㅓ","ㅔ","ㅕ",["ㅕ","ㅣ"],"ㅗ",["ㅗ","ㅏ"],["ㅗ","ㅐ"],["ㅗ","ㅣ"],"ㅛ","ㅜ",["ㅜ","ㅓ"],["ㅜ","ㅔ"],["ㅜ","ㅣ"],"ㅠ","ㅡ",["ㅡ","ㅣ"],"ㅣ"],C=["","ㄱ",["ㄱ","ㄱ"],["ㄱ","ㅅ"],"ㄴ",["ㄴ","ㅈ"],["ㄴ","ㅎ"],"ㄷ","ㄹ",["ㄹ","ㄱ"],["ㄹ","ㅁ"],["ㄹ","ㅂ"],["ㄹ","ㅅ"],["ㄹ","ㅌ"],["ㄹ","ㅍ"],["ㄹ","ㅎ"],"ㅁ","ㅂ",["ㅂ","ㅅ"],"ㅅ",["ㅅ","ㅅ"],"ㅇ","ㅈ","ㅊ","ㅋ","ㅌ","ㅍ","ㅎ"],A=44032;function n(n){for(var r=n.length,t={0:0},e=0;e<r;e++)n[e]&&(t[n[e].charCodeAt(0)]=e);return t}function o(n){for(var r,t,e=n.length,o={},i=0;i<e;i++)r=n[i][0].charCodeAt(0),t=n[i][1].charCodeAt(0),void 0===o[r]&&(o[r]={}),o[r][t]=n[i][2].charCodeAt(0);return o}function v(n){return void 0!==r[n]}function y(n){return void 0!==d[n]}function m(n){return void 0!==g[n]}function u(n){return void 0!==l[n]}function j(n){return 44032<=n&&n<=55203}function b(n,r){return!(!e[n]||!e[n][r])&&e[n][r]}function S(n,r){return!(!t[n]||!t[n][r])&&t[n][r]}r=n(["ㄱ","ㄲ","ㄳ","ㄴ","ㄵ","ㄶ","ㄷ","ㄸ","ㄹ","ㄺ","ㄻ","ㄼ","ㄽ","ㄾ","ㄿ","ㅀ","ㅁ","ㅂ","ㅃ","ㅄ","ㅅ","ㅆ","ㅇ","ㅈ","ㅉ","ㅊ","ㅋ","ㅌ","ㅍ","ㅎ"]),d=n(["ㄱ","ㄲ","ㄴ","ㄷ","ㄸ","ㄹ","ㅁ","ㅂ","ㅃ","ㅅ","ㅆ","ㅇ","ㅈ","ㅉ","ㅊ","ㅋ","ㅌ","ㅍ","ㅎ"]),g=n(["ㅏ","ㅐ","ㅑ","ㅒ","ㅓ","ㅔ","ㅕ","ㅖ","ㅗ","ㅘ","ㅙ","ㅚ","ㅛ","ㅜ","ㅝ","ㅞ","ㅟ","ㅠ","ㅡ","ㅢ","ㅣ"]),l=n(["","ㄱ","ㄲ","ㄳ","ㄴ","ㄵ","ㄶ","ㄷ","ㄹ","ㄺ","ㄻ","ㄼ","ㄽ","ㄾ","ㄿ","ㅀ","ㅁ","ㅂ","ㅄ","ㅅ","ㅆ","ㅇ","ㅈ","ㅊ","ㅋ","ㅌ","ㅍ","ㅎ"]),t=o([["ㄱ","ㅅ","ㄳ"],["ㄴ","ㅈ","ㄵ"],["ㄴ","ㅎ","ㄶ"],["ㄹ","ㄱ","ㄺ"],["ㄹ","ㅁ","ㄻ"],["ㄹ","ㅂ","ㄼ"],["ㄹ","ㅅ","ㄽ"],["ㄹ","ㅌ","ㄾ"],["ㄹ","ㅍ","ㄿ"],["ㄹ","ㅎ","ㅀ"],["ㅂ","ㅅ","ㅄ"],["ㄱ","ㄱ","ㄲ"],["ㄷ","ㄷ","ㄸ"],["ㅂ","ㅂ","ㅃ"],["ㅅ","ㅅ","ㅆ"],["ㅈ","ㅈ","ㅉ"]]),e=o([["ㅗ","ㅏ","ㅘ"],["ㅗ","ㅐ","ㅙ"],["ㅗ","ㅣ","ㅚ"],["ㅜ","ㅓ","ㅝ"],["ㅜ","ㅔ","ㅞ"],["ㅜ","ㅣ","ㅟ"],["ㅡ","ㅣ","ㅢ"]]);function w(n,r){if(null===n)throw new Error("Arguments cannot be null");"object"==typeof n&&(n=n.join(""));for(var t,e,o,i,u,f=[],c=n.length,a=0;a<c;a++){var s=[];j(i=n.charCodeAt(a))?(e=((i-=A)-(o=i%28))/28%21,t=parseInt((i-o)/28/21),"object"==typeof h[t]?s=s.concat(h[t]):s.push(h[t]),"object"==typeof p[e]?s=s.concat(p[e]):s.push(p[e]),0<o&&("object"==typeof C[o]?s=s.concat(C[o]):s.push(C[o]))):v(i)?"string"==typeof(u=y(i)?h[d[i]]:C[l[i]])?s.push(u):s=s.concat(u):m(i)?"string"==typeof(u=p[g[i]])?s.push(u):s=s.concat(u):s.push(n.charAt(a)),r?f.push(s):f=f.concat(s)}return f}function i(n){return"string"!=typeof n?"":(n=w(n)).join("")}function f(c){"string"==typeof c&&(c=w(c));var n,r,a=[],t=c.length,e=0,s=-1,h=!1;function o(n){var r,t,e,o,i=0,u="";if(h=!1,!(n<s+1))for(var f=1;;f++){if(1===f){if(m(r=c[s+f].charCodeAt(0)))return s+f+1<=n&&m(t=c[s+f+1].charCodeAt(0))?a.push(String.fromCharCode(b(r,t))):a.push(c[s+f]),void(s=n);if(!y(r))return a.push(c[s+f]),void(s=n);u=c[s+f]}else if(2===f){if(y(t=c[s+f].charCodeAt(0)))return r=S(r,t),u=String.fromCharCode(r),a.push(u),void(s=n);u=String.fromCharCode(28*(21*d[r]+g[t])+A)}else 3===f?(b(t,e=c[s+f].charCodeAt(0))?t=b(t,e):i=e,u=String.fromCharCode(28*(21*d[r]+g[t])+l[i]+A)):4===f?(i=S(i,o=c[s+f].charCodeAt(0))?S(i,o):o,u=String.fromCharCode(28*(21*d[r]+g[t])+l[i]+A)):5===f&&(i=S(i,o=c[s+f].charCodeAt(0)),u=String.fromCharCode(28*(21*d[r]+g[t])+l[i]+A));if(n<=s+f)return a.push(u),void(s=n)}}for(var i=0;i<t;i++)y(n=c[i].charCodeAt(0))||m(n)||u(n)?(0===e?y(n)?e=1:m(n)&&(e=4):1==e?m(n)?e=2:S(r,n)?e=5:o(i-1):2==e?u(n)?e=3:m(n)?b(r,n)||(o(i-1),e=4):(o(i-1),e=1):3==e?u(n)?!h&&S(r,n)?h=!0:(o(i-1),e=1):y(n)?(o(i-1),e=1):m(n)&&(o(i-2),e=2):4==e?m(n)?b(r,n)?(o(i),e=0):o(i-1):(o(i-1),e=1):5==e&&(e=m(n)?(o(i-2),2):(o(i-1),1)),r=n):(o(i-1),o(i),e=0);return o(i-1),a.join("")}function c(n){this.string=n,this.disassembled=w(n).join("")}c.prototype.search=function(n){return w(n).join("").indexOf(this.disassembled)};var a={disassemble:w,d:w,disassembleToString:i,ds:i,assemble:f,a:f,search:function(n,r){var t=w(n).join(""),e=w(r).join("");return t.indexOf(e)},rangeSearch:function(n,r){var t,e=w(n).join(""),o=w(r).join(""),i=w(n,!0),u=new RegExp(o,"gi"),f=[];if(!r.length)return[];for(;t=u.exec(e);)f.push(t.index);return f.map(function(n){return[function(n){for(var r=0,t=0;r<i.length;++r)if(n<(t+=i[r].length))return r}(n),function(n){for(var r=0,t=0;r<i.length;++r)if(t+=i[r].length,n+o.length<=t)return r}(n)]})},Searcher:c,endsWithConsonant:function(n){"object"==typeof n&&(n=n.join(""));var r=n.charCodeAt(n.length-1);if(j(r)){if(0<(r-=A)%28)return!0}else if(v(r))return!0;return!1},endsWith:function(n,r){return w(n).pop()===r},isHangul:function(n){return"string"==typeof n&&(n=n.charCodeAt(0)),j(n)},isComplete:function(n){return"string"==typeof n&&(n=n.charCodeAt(0)),j(n)},isConsonant:function(n){return"string"==typeof n&&(n=n.charCodeAt(0)),v(n)},isVowel:function(n){return"string"==typeof n&&(n=n.charCodeAt(0)),m(n)},isCho:function(n){return"string"==typeof n&&(n=n.charCodeAt(0)),y(n)},isJong:function(n){return"string"==typeof n&&(n=n.charCodeAt(0)),u(n)},isHangulAll:function(n){if("string"!=typeof n)return!1;for(var r=0;r<n.length;r++)if(!j(n.charCodeAt(r)))return!1;return!0},isCompleteAll:function(n){if("string"!=typeof n)return!1;for(var r=0;r<n.length;r++)if(!j(n.charCodeAt(r)))return!1;return!0},isConsonantAll:function(n){if("string"!=typeof n)return!1;for(var r=0;r<n.length;r++)if(!v(n.charCodeAt(r)))return!1;return!0},isVowelAll:function(n){if("string"!=typeof n)return!1;for(var r=0;r<n.length;r++)if(!m(n.charCodeAt(r)))return!1;return!0},isChoAll:function(n){if("string"!=typeof n)return!1;for(var r=0;r<n.length;r++)if(!y(n.charCodeAt(r)))return!1;return!0},isJongAll:function(n){if("string"!=typeof n)return!1;for(var r=0;r<n.length;r++)if(!u(n.charCodeAt(r)))return!1;return!0}};"function"==typeof define&&define.amd?define(function(){return a}):"undefined"!=typeof module?module.exports=a:window.Hangul=a}();
</script>
<style>
body {
    background-color: white ;
    font-family: 'Helvetica', 'sans serif';
    font-size: medium;
	line-height: 1.5;
    min-width: 760px;
    margin: 0 auto;
}
.page {
    width: 90%;
    margin-left: auto;
    margin-right: auto;
    padding: 1em;
}
p {
    padding: 4px;
    background: white;
    color: black;
}
input {
    padding: 4px;
    border: 1px solid lightsalmon;
    transition: box-shadow 0.3s;
    background: lightyellow;
    border-radius: 5px;
    color: black;
    font-family: 'Helvetica', 'sans serif';
    font-size: large;
}

input:focus { 
    border: 1px solid teal;
    box-shadow: 0 0 5px 1px powderblue;
}
button {
    color: black;
    font-family: 'Helvetica', 'sans serif';
    font-size: large;
    font-weight: bold;
    margin-top: 6px;
}
#play {
    color: blue;
}
#stop {
    color: red;
}
#freq { 
    width: 3em;
}
#speed {
    width: 3em;
}
#volume {
    width: 3em;
}
textarea {
    width : 100%;
    height : auto;
    padding: 10px;
    border: 1px solid lightsalmon;
    transition: box-shadow 0.3s;
    background: lightyellow;
    border-radius: 5px;
    color: black;
    font-family: 'Helvetica', 'sans serif';
    font-size: x-large;
    font-weight: bold;
    line-height: 1.5;
}
#counter {
    float: right;
}
.font_medium {
    font-size : medium;
}
.setting {
    line-height: 2;
    margin-top: 0px;    
}
.setting_bold {
    font-weight: 600;
}
.setting_group {
    padding: 4px 0px 4px 10px;
    margin-right: 10px;
    border: 1px dotted teal;
    white-space: nowrap;
}
.setting_group_2 {
    margin-right: 10px;
    white-space: nowrap;
}
.sample_group > button {
    margin-top: 7px;
    margin-bottom: 4px;
}
::selection {
    background-color: rgba(255, 0, 0, 0.5);
}
.hidden_sample {
    display : none;
}

.CodeMirror {
    width : 100%;
    height : 12em;
    padding: 10px;
    border: 1px solid lightsalmon;
    transition: box-shadow 0.3s;
    background: lightyellow;
    border-radius: 5px;
    color: black;
    font-family: 'Helvetica', 'sans serif';
    font-size: x-large;
    font-weight: bold;
    line-height: 1.5;
    margin-top: 20px;
}
.CodeMirror-selected { background-color: rgba(255, 0, 0, 0.5); }
.CodeMirror-focused .CodeMirror-selected { background-color: rgba(255, 0, 0, 0.5); }
.hide_markText { background-color: black; }
.show_markText { background-color: inherit; }

.log_container_ditdah {
    width : 100%;
    height : 12px;
    overflow: hidden;
    padding: 10px;
    border: 1px solid lightsalmon;
    transition: box-shadow 0.3s;
    background: lightyellow;
    border-radius: 5px;
    color: black;
    font-family: 'monospace';
    font-size: small;
    white-space: nowrap;
    margin-top: 0px;
}
#ditdah {
    height:10px;
    float: right;
}
.ditdah_bar {
    background: green;
    height: 10px;
    display: inline-block;
}
.ditdah_gap {
    height: 10px;
    display: inline-block;
}
#keyer_setting {
    display: none;
    line-height: 2;
}
#connect {
    color: blue;
}
#disconnect {
    color: red;
}
#mp3 {
	display: inline-block;
	margin: auto;
	padding-left: 10px;
}
audio {
	height: 1em;
	margin-bottom: -3px;
}
</style>
</head>
<body>
<div class="page">

<p><span style="font-size:200%"><b>A special course for DS5TUK</b></span>
    <span style="font-size:150%">&nbsp;</span>
</p>

<div class="setting">
    <span class="setting_group_2">
        <button id="play">PLAY</button>&nbsp;
        <button id="stop">STOP</button>
        </span>   

<span class="setting_group_2">
<span class="setting_bold">음색</span> <input type="number" id="freq" value="650" step="10" size="4" min="200" max="1200" /> Hz
&nbsp;
<span class="setting_bold">속도</span> <input type="number" id="speed" value="10" size="2" min="5" max="50" /> WPM
<!--&nbsp;
<span class="setting_bold">음량</span> <input type="number" id="volume" value="100" size="3" min="1" max="100" step="1" /> %-->
</span>
<span class="setting_group">
<span class="setting_bold">부호간격</span> : 
<label><input type="radio" name="key" value="computer" /> 정상</label>&nbsp;
<label><input type="radio" name="key" value="space_1" /> 1></label>&nbsp;
<label><input type="radio" name="key" value="space_2" /> 2>></label>&nbsp;
<label><input type="radio" name="key" value="space_3" checked /> 3>>></label>&nbsp;
<label><input type="radio" name="key" value="space_4" /> 4>>>></label>&nbsp;
<label><input type="radio" name="key" value="space_5" /> 5>>>>></label>&nbsp;
</span>&nbsp;&nbsp;

<span class="setting_group">
<span class="setting_bold">글자숨기기</span> : 
<label id="selection_only" ></label>
<label><input type="checkbox" id="hide_now" onchange="onChangeHideAlways();"> 항상</label>&nbsp;
<label><input type="checkbox" id="hide_text"> PLAY할때</label>&nbsp;
<label><input type="checkbox" id="highlight_slowly"> 한글자씩보기</label>
<!--<label id="repeat" ></label>-->
<label id="flute"></label>
<label id="noise"></label>
<label id="fading"></label>&nbsp;
</span>&nbsp;&nbsp;

<span class="setting_group">
<label><input type="checkbox" id="repeat" > 연속 반복</label>&nbsp;&nbsp;
</span>
</div>



<div>
<span class="sample_group">
<!--button style="background-color:rgb(240, 250, 200);" onClick="location.href='/morse/practice/eng-1.html'">&nbsp;1단계&nbsp;</button>&nbsp;
<button style="color:rgb(80, 80, 80);" onClick="location.href='/morse/practice/eng-2.html'">&nbsp;2단계&nbsp;</button>&nbsp;
<button style="color:rgb(80, 80, 80);" onClick="location.href='/morse/practice/eng-3.html'">&nbsp;3단계&nbsp;</button>&nbsp;
<button style="color:rgb(80, 80, 80);" onClick="location.href='/morse/practice/eng-4.html'">&nbsp;4단계&nbsp;</button>&nbsp;
<button style="color:rgb(80, 80, 80);" onClick="location.href='/morse/practice/eng-5.html'">&nbsp;5단계&nbsp;</button>&nbsp;
<button style="color:rgb(80, 80, 80);" onClick="location.href='/morse/practice/eng-6.html'">&nbsp;6단계&nbsp;</button>&nbsp;
<button style="color:rgb(80, 80, 80);" onClick="location.href='/morse/practice/eng-7.html'">&nbsp;7단계&nbsp;</button>&nbsp;
<button style="color:rgb(80, 80, 80);" onClick="location.href='/morse/practice/eng-8.html'">&nbsp;8단계&nbsp;</button>&nbsp;
<button style="color:rgb(80, 80, 80);" onClick="location.href='/morse/practice/eng-9.html'">&nbsp;9단계&nbsp;</button>&nbsp;
<button style="color:rgb(80, 80, 80);" onClick="location.href='/morse/practice/eng-10.html'">&nbsp;10단계&nbsp;</button>&nbsp;
<button style="color:rgb(80, 80, 80);" onClick="location.href='/morse/practice/eng-11.html'">&nbsp;11단계&nbsp;</button>&nbsp;
<button style="color:rgb(80, 80, 80);" onClick="location.href='/morse/practice/eng-12.html'">&nbsp;12단계&nbsp;</button>&nbsp;
<button style="color:rgb(80, 80, 80);" onClick="location.href='/morse/practice/eng-13.html'">&nbsp;13단계&nbsp;</button>&nbsp;
<button style="color:rgb(80, 80, 80);" onClick="location.href='/morse/practice/eng-14.html'">&nbsp;14단계&nbsp;</button-->

<label id="hangul_qso_1"></label>
<label id="user_qso"></label>

</span>
</div>

<div class="log_container_ditdah"><span id="ditdah"></span></div>

<button id="sub_menu_1" style="background-color:rgb(236, 248, 168);"> TUK 100% 15개 </button>&nbsp;
<button id="sub_menu_2" style="background-color:rgb(236, 248, 168);"> TUK 100% 30개 </button>&nbsp;
<button id="sub_menu_3" style="background-color:rgb(159, 187, 247);"> TUK:기타 (3:2) 15개 </button>&nbsp;
<button id="sub_menu_4" style="background-color:rgb(159, 187, 247);"> TUK:기타 (3:2) 30개 </button>&nbsp;
<button id="sub_menu_5" style="background-color:rgb(204, 241, 55);"> TUK:기타 (2:3) 15개 </button>&nbsp;
<button id="sub_menu_6" style="background-color:rgb(204, 241, 55);"> TUK:기타 (2:3) 30개 </button>&nbsp;
<button id="sub_menu_7" style="background-color:rgb(252, 185, 224);"> TUK:기타 (1:3) 15개 </button>&nbsp;
<button id="sub_menu_8" style="background-color:rgb(252, 185, 224);"> TUK:기타 (1:3) 30개 </button>


<!--  hangul_txt_1         -->
<textarea id="hangul_txt_1" rows="10">

- 사각 메뉴를 클릭하면 연습 내용이 만들어짐.

- 누를 때마다 내용이 바뀜. (세 번째 메뉴부터)

- 속도와 부호간격을 조절한 후, PLAY.
</textarea>
<div id="hangul_txt_1_caption"></div>

<!--  user_txt         -->
<textarea id="user_txt" rows="16" class="hidden_sample">
</textarea>
<div id="user_txt_caption" class="hidden_sample">
<label><input type="radio" name="repeat_count" value="1" checked /></label>
</div>

<br>

</div>
</body>

<!--script>Mp3LameEncoderConfig = { memoryInitializerPrefixURL: "" };</script-->
<script src="Mp3LameEncoder.min.js"></script>
<script type="text/javascript">
(function(AudioContext) {
    AudioContext.prototype.createEffect = function() {
        var bufferSize = 4096;
        var node = this.createScriptProcessor(bufferSize, 1, 1);
        node.onaudioprocess = function(e) {
            const inputBuffer = e.inputBuffer;
            const outputBuffer = e.outputBuffer;

            // Loop through the output channels (in this case there is only one)
            for (let channel = 0; channel < outputBuffer.numberOfChannels; channel++) {
                const inputData = inputBuffer.getChannelData(channel);
                const outputData = outputBuffer.getChannelData(channel);

                // Loop through the 4096 samples
                for (let sample = 0; sample < inputBuffer.length; sample++) {
                    // make output equal to the same as the input
                    outputData[sample] = inputData[sample];

                    // add noise to each output sample
                    if (useNoise) outputData[sample] += ((Math.random() * 2) - 1) * 0.9; //  white noise. 0.2 noise strength 
                }
            }
        }
        return node;
    };
    
    AudioContext.prototype.createWhiteNoise = function(bufferSize) {
        bufferSize = bufferSize || 4096;
        var node = this.createScriptProcessor(bufferSize, 1, 1);
        node.onaudioprocess = function(e) {
            var output = e.outputBuffer.getChannelData(0);
            for (var i = 0; i < bufferSize; i++) {
                output[i] = Math.random() * 2 - 1;
            }
        }
        return node;
    };

    AudioContext.prototype.createPinkNoise = function(bufferSize) {
        bufferSize = bufferSize || 4096;
        var b0, b1, b2, b3, b4, b5, b6;
        b0 = b1 = b2 = b3 = b4 = b5 = b6 = 0.0;
        var node = this.createScriptProcessor(bufferSize, 1, 1);
        node.onaudioprocess = function(e) {
            var output = e.outputBuffer.getChannelData(0);
            for (var i = 0; i < bufferSize; i++) {
                var white = Math.random() * 2 - 1;
                b0 = 0.99886 * b0 + white * 0.0555179;
                b1 = 0.99332 * b1 + white * 0.0750759;
                b2 = 0.96900 * b2 + white * 0.1538520;
                b3 = 0.86650 * b3 + white * 0.3104856;
                b4 = 0.55000 * b4 + white * 0.5329522;
                b5 = -0.7616 * b5 - white * 0.0168980;
                output[i] = b0 + b1 + b2 + b3 + b4 + b5 + b6 + white * 0.5362;
                output[i] *= 0.11; // (roughly) compensate for gain
                b6 = white * 0.115926;
            }
        }
        return node;
    };

    AudioContext.prototype.createBrownNoise = function(bufferSize) {
        bufferSize = bufferSize || 4096;
        var lastOut = 0.0;
        var node = this.createScriptProcessor(bufferSize, 1, 1);
        node.onaudioprocess = function(e) {
            var output = e.outputBuffer.getChannelData(0);
            for (var i = 0; i < bufferSize; i++) {
                var white = Math.random() * 2 - 1;
                output[i] = (lastOut + (0.02 * white)) / 1.02;
                lastOut = output[i];
                output[i] *= 3.5; // (roughly) compensate for gain
            }
        }
        return node;
    };
})(window.AudioContext);

</script>
<script type="text/javascript">
MorseNode.prototype.MORSE = {
    "A": ".-",
    "B": "-...",
    "C": "-.-.",
    "D": "-..",
    "E": ".",
    "F": "..-.",
    "G": "--.",
    "H": "....",
    "I": "..",
    "J": ".---",
    "K": "-.-",
    "L": ".-..",
    "M": "--",
    "N": "-.",
    "O": "---",
    "P": ".--.",
    "Q": "--.-",
    "R": ".-.",
    "S": "...",
    "T": "-",
    "U": "..-",
    "V": "...-",
    "W": ".--",
    "X": "-..-",
    "Y": "-.--",
    "Z": "--..",

    "1": ".----",
    "2": "..---",
    "3": "...--",
    "4": "....-",
    "5": ".....",
    "6": "-....",
    "7": "--...",
    "8": "---..",
    "9": "----.",
    "0": "-----",
    
    ".": ".-.-.-",
    ",": "--..--",
    "?": "..--..",
    "/": "-..-.",
    "+": ".-.-.",
    "-": "-....-",
    "=": "-...-",
    ":": "---...",
    ";": "-.-.-.",
    "(": "-.--.",
    ")": "-.--.-",
    "'": ".----.",
    "\"": ".-..-.",
    "@": ".--.-.",
    
    "ㄱ": ".-..",
    "ㄴ": "..-.",
    "ㄷ": "-...",
    "ㄹ": "...-",
    "ㅁ": "--",
    "ㅂ": ".--",
    "ㅅ": "--.",
    "ㅇ": "-.-",
    "ㅈ": ".--.",
    "ㅊ": "-.-.",
    "ㅋ": "-..-",
    "ㅌ": "--..",
    "ㅍ": "---",
    "ㅎ": ".---",
    "ㅏ": ".",
    "ㅑ": "..",
    "ㅓ": "-",
    "ㅕ": "...",
    "ㅗ": ".-",
    "ㅛ": "-.",
    "ㅜ": "....",
    "ㅠ": ".-.",
    "ㅡ": "-..",
    "ㅣ": "..-",
    "ㅔ": "-.--",
    "ㅐ": "--.-",
    
    // for prosign
    "&" : ".-...",
    "Ŝ" : "...-.",
    // non-standard
    "[" : "-...-.-",
    "]" : "...-.-",
    "^" : "-.-.-",
    "※" : "........"
};

MorseNode.prototype.PROSIGN = {
    "<AR>" : "+",
    "<KN>" : "(",
    "<AS>" : "&",
    "<BT>" : "=",
    "<SN>" : "Ŝ",
    // non-standard
    "<BK>" : "[",
    "<SK>" : "]",
    "<VA>" : "]",
    "<KA>" : "^",
    "<HH>" : "※"
};

function MorseNode(ac, rate) {
    // ac is an audio context.
    this._oscillator = ac.createOscillator();
    this._gain = ac.createGain();

    this._gain.gain.value = 0;
    this._oscillator.type = 'sine';
    this._oscillator.frequency.value = 600;
    
    this._oscillator.connect(this._gain);
    this.key = 'computer';

    if ("undefined" == typeof rate)
        rate = 20;
    this._dot = 1.2 / rate; // formula from Wikipedia.

    this._oscillator.start(0);
	this._moved = 0;
}

MorseNode.prototype.connect = function(target) {
    return this._gain.connect(target);
}

MorseNode.prototype.timeMove = function(sec) {
	if (ac.currentTime + this._moved + sec < queue[0][0]) sec = queue[0][0] - ac.currentTime - this._moved;
	else if (ac.currentTime + this._moved + sec > queue[queue.length - 1][0]) sec = queue[queue.length - 1][0] - ac.currentTime - this._moved;
	this._moved += sec;
	
	console.log(sec);
	
	var i = 0;
	for (; i < queue.length; i++)
		if (queue[i][0] > ac.currentTime + this._moved) break;
	
	this._gain.disconnect(filter);
	this._oscillator.disconnect(this._gain);
	this._gain = ac.createGain();
	this._gain.gain.value = 0;
	this._oscillator.connect(this._gain);
	this._gain.connect(filter);
	
	for (; i < queue.length; i++)
		this._gain.gain.setValueAtTime(queue[i][1], queue[i][0] - this._moved);
	
	var min = timestamp[0];
	timestamp.forEach((el, idx, ary) => { ary[idx] = el - sec; });
}

MorseNode.prototype.dotfac = function(t) {
    switch (this.key) {
            // t is type of dotvalue. l=letter int. i=inter el. s=spaces .=dit -=dah 
        case 'computer':
            return 1;
		case 'straightmed': //i and . are rather too long than too short, s the inverse rest is random
            if (t=='.' || t=='i') return Math.random()*0.33+0.95;
            if (t=='s') return Math.random()*0.2+0.85;
            return Math.random()*0.3+0.85;
        case 'straightbad':
            if (t=='.' || t=='i') return Math.random()*0.6+0.8;
            if (t=='s') return Math.random()*0.4+0.7;
            return Math.random()*0.5+0.75;
        case 'straightvbad':
            if (t=='.' || t=='i') return Math.random()*1.6+0.8;
            if (t=='s') return Math.random()*0.85+0.4;
            return Math.random()*0.8+0.6;
        case 'space_1':
			if (t=='s') return 1.6;
            if (t=='l') return 1.6;
        case 'space_2':
			if (t=='s') return 2.2;
            if (t=='l') return 2.2;
        case 'space_3':
			if (t=='s') return 3;
            if (t=='l') return 3;
        case 'space_4':
			if (t=='s') return 4;
            if (t=='l') return 4;            
        case 'space_5':
			if (t=='s') return 5;
            if (t=='l') return 5;            
        case 'farnsworth': //uses farnsworth
            if (t=='s') return 6;
            if (t=='l') return 4;
        case 'elmer': //uses farnsworth
            if (t=='s') return 4;
            if (t=='l') return 1.5;
            return 1;
        }

}

var smoothingDuration = 0.004;  // 10ms is very soft, icom default 4ms;
MorseNode.prototype.playChar = function(queueOnly, t, c, v) {
    for (var i = 0; i < c.length; i++) {
        switch(c[i]) {
        case '.':
            if (!queueOnly) {
				this._gain.gain.setValueAtTime(0, t - smoothingDuration);
				this._gain.gain.linearRampToValueAtTime(1.0 * v, t);
			}
			enQueue(1.0 * v, t);
            t += this._dot * this.dotfac('.');
            if (!queueOnly) {
				this._gain.gain.setValueAtTime(1.0 * v, t - smoothingDuration);
				this._gain.gain.linearRampToValueAtTime(0.0, t);
			}
			enQueue(0.0, t)
            break;
        case '-':
            if (!queueOnly) {
				this._gain.gain.setValueAtTime(0, t - smoothingDuration);
				this._gain.gain.linearRampToValueAtTime(1.0 * v, t);
			}
			enQueue(1.0 * v, t);
            t += 3 * this._dot * this.dotfac('-');
            if (!queueOnly) {
				this._gain.gain.setValueAtTime(1.0 * v, t - smoothingDuration);
				this._gain.gain.linearRampToValueAtTime(0.0, t);
			}
			enQueue(0.0, t)
            break;
        }
        t += this._dot * this.dotfac('i');
    }
    return t;
}

var timestamp = [];
var queue = [];
function enQueue(v, t) {
	queue.push([t, v]);
}
var hasHangul = false;

MorseNode.prototype.playString = function(queueOnly, t, w, v, k, fade) {
    this.key = k;
    
    w = this.convertHangulAndProsign(w.toUpperCase());
    timestamp = [];
	queue = [];
	enQueue(0, 0);
	hasHangul = false;
    
    var start = t, fv = v;
    for (var n = 0; n < w.length; n++) {
        if (fade && (t - start) > 0) { // skip face effect during first 10s
            var pointOneSec = parseInt((t - start) * 10) % 150;
            if (pointOneSec < 75) fv = v * (100 - pointOneSec) * 0.01; // gradually goes down to the quarter volume for 7.5 sec
            else fv = v * (pointOneSec - 50) * 0.01; // gradually goes up to the normal volume for 7.5 sec
        }
        if (!highlightSlowly.checked) timestamp.push(t);
        var c = w[n];
        var hangul = (c.length > 1);
        for (var i = 0; i < c.length; i++) {
            if (c[i] == ' ' || c[i] == '\u00A0') {
                t += 4 * this._dot * this.dotfac('s'); // 3 dots gap already added after ending letter before
            }
            else if ("undefined" != typeof this.MORSE[c[i]]) {
                t = this.playChar(queueOnly, t, this.MORSE[c[i]], fv); // 1 gap after dit/dah
                t += 2 * this._dot * this.dotfac('l'); // with this 2 more gap, whole gap between letter is 3
            }
        }
        if (hangul) {
            t += (2+2) * this._dot * this.dotfac('l');
			hasHangul = true;
        }
        if (highlightSlowly.checked) timestamp.push(t);
    }
    timestamp.push(t);
    
    return t;
}

MorseNode.prototype.convertHangulAndProsign = function(w) {
    // convert prosign
    for (var key in this.PROSIGN) {
        w = w.replace(new RegExp(key.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g'), this.PROSIGN[key]);
    }
    return Hangul.disassemble(w, true);
}

MorseNode.prototype.getSpaceDelayInMills = function() {
    return 1000 * this._dot * (this.dotfac('i') + 2 * this.dotfac('l') + 4 * this.dotfac('s'));
}


var ac, filter, morse = null, vol = 1.0, cwPort = null, cwPortInitialized = false, cwPortOpen = false;

var ua = navigator.userAgent.toLowerCase();
var isIOS = (ua.indexOf("iphone") > -1 || ua.indexOf("ipad") > -1 || ua.indexOf("ipod") > -1);
var isAndroid = ua.indexOf("android") > -1;
var isMobile = (isIOS || isAndroid);

var freq = document.querySelector("#freq")
var wpm = document.querySelector("#speed");
//var volume = document.querySelector("#volume");
var play = document.querySelector("#play");
var stop = document.querySelector("#stop");
var keyComputer = document.querySelector('input[name="key"][value="computer"]');
//var keyElmer = document.querySelector('input[name="key"][value="elmer"]');
//var keyFarnsworth = document.querySelector('input[name="key"][value="farnsworth"]');
var keySpace1 = document.querySelector('input[name="key"][value="space_1"]');
var keySpace2 = document.querySelector('input[name="key"][value="space_2"]');
var keySpace3 = document.querySelector('input[name="key"][value="space_3"]');
var keySpace4 = document.querySelector('input[name="key"][value="space_4"]');
var keySpace5 = document.querySelector('input[name="key"][value="space_5"]');
//var keyStraightMed = document.querySelector('input[name="key"][value="straightmed"]');
//var keyStraightBad = document.querySelector('input[name="key"][value="straightbad"]');
//var keyStraightVBad = document.querySelector('input[name="key"][value="straightvbad"]');
var flute = document.querySelector("#flute");
var noise = document.querySelector("#noise");
var fading = document.querySelector("#fading");
var selectionOnly = document.querySelector("#selection_only");
var highlightSlowly = document.querySelector("#highlight_slowly");
var hideText = document.querySelector("#hide_text");
var repeat = document.querySelector("#repeat");


function renewMorse() {
    ac = (ac || new AudioContext());
    if (ac.state != "running") ac.resume();

    if (morse != null) morse._oscillator.stop(0);
    morse = new MorseNode(ac, parseInt(wpm.value));
    
    filter = ac.createBiquadFilter(); 
    filter.frequency.value = freq.value;
    filter.Q.value = 0;
    
    morse.connect(filter);
    filter.connect(ac.destination);
    
    morse._dot = 1.2 / parseFloat(wpm.value);
    morse._oscillator.frequency.value = parseInt(freq.value);
}
var stopped = true, paused = false;
var cm, doc, txtValue, cursorFrom = null, cursorTo, cursorTempFrom, cursorTempTo, cursorTempEnd, highlightStart, hightlightEnd, repeatId = -1, marker = null;
var DELAY_AMOUNT = 1; // seconds

stop.onclick = function() {
    try { clearTimeout(repeatId); repeatId = -1;}
    catch (e) {}
    
    renewMorse();
    if (noiseNode) noiseGain.disconnect();
    morse.playString(false, ac.currentTime, " ", vol, document.querySelector('input[name="key"]:checked').value, fading.checked);
    doc.readOnly = false;
    
    addDitdah(false, 1); // this also manage cw port
	
	clearMarker();
	cm.setOption("extraKeys", {});
    cm.focus();
    if (cursorFrom != null) {
        doc.setSelection(cursorFrom, cursorTo);
        cm.refresh();
    }
    stopped = true;

    play.replaceChild(document.createTextNode("PLAY"), play.firstChild);
    paused = false;
}
var bufferSource = noiseNode = noiseGain = null;

play.onclick = function() {
    if (paused) {
        play.replaceChild(document.createTextNode("PAUSE"), play.firstChild);
        paused = false;
        ac.resume();
        return;
    } else if (stopped == false && repeatId == -1) {
        play.replaceChild(document.createTextNode("RESUME"), play.firstChild);
        paused = true;
        ac.suspend();
        return;
    } else {
        play.replaceChild(document.createTextNode("PAUSE"), play.firstChild);
        paused = false;
    }
    
    try { clearTimeout(repeatId); repeatId = -1;}
    catch (e) {}

    renewMorse();
    
    if (noise.checked) {
        if (bufferSource == null) {
            bufferSource = ac.createBufferSource();
            noiseNode = ac.createWhiteNoise();
            bufferSource.connect(noiseNode);
            noiseGain = ac.createGain();
            noiseNode.connect(noiseGain);
            bufferSource.start(0);
        }
        noiseGain.gain.value = vol * 0.5;
        noiseGain.connect(ac.destination);
    }
    
    clearMarker();
    cm.focus();
    if (cursorFrom != null && !stopped) {
        doc.setSelection(cursorFrom, cursorTo);
        cm.refresh();
        previousTime = 0;
    } else clearDitdah();
    
    cursorFrom = doc.getCursor("from");
    cursorTo = doc.getCursor("to");
    txtValue = doc.getSelection();
    
    var lastLine = doc.lastLine();
    var lastLineLength = doc.getLine(lastLine).length;
    
    if (selectionOnly.checked) {
        if (txtValue == '') { // when no selection  
            if (cursorTo.line == lastLine && cursorTo.ch == lastLineLength) { // when caret is at the end, start from first letter
                txtValue = doc.getValue();
                cursorTempFrom = {line: 0, ch: 0};
                cursorTempTo = {line: 0, ch: 0};
                cursorTempEnd = {line: lastLine, ch: lastLineLength};
            } else { // when caret is in the middle, start from caret position
                doc.setSelection(cursorFrom, {line: lastLine, ch: lastLineLength});
                txtValue = doc.getSelection();
                doc.setSelection(cursorFrom, cursorTo);
                cursorTempFrom = {line: cursorFrom.line, ch: cursorFrom.ch};
                cursorTempTo = {line: cursorFrom.line, ch: cursorFrom.ch};
                cursorTempEnd = {line: lastLine, ch: lastLineLength}
            }
        } else { // play selection
            cursorTempFrom = {line: cursorFrom.line, ch: cursorFrom.ch};
            cursorTempTo = {line: cursorFrom.line, ch: cursorFrom.ch};
            cursorTempEnd = {line: cursorTo.line, ch: cursorTo.ch};
        }
    } else {
        txtValue = doc.getValue();
        cursorTempFrom = {line: 0, ch: 0};
        cursorTempTo = {line: 0, ch: 0};
        cursorTempEnd = {line: lastLine, ch: lastLineLength};
    }
    highlightStart = highlightEnd = 0;
    
    morse.playString(false, ac.currentTime + DELAY_AMOUNT, 
        txtValue, 
        vol * (noise.checked ? 0.5 : 1), 
        document.querySelector('input[name="key"]:checked').value,
        fading.checked);
    
    doc.readOnly = true;

    window.localStorage.setItem('user_txt', userTxt.CodeMirror.doc.getValue());
    
    stopped = false;
    
    cm.focus();
    if (highlightSlowly.checked) doc.setSelection(cursorTempFrom, cursorTempFrom);
    if (hideText.checked) setMarker(cursorTempFrom, cursorTempEnd);
	cm.setOption("extraKeys", { Left: function() {rollback(true);}, Right: function() {rollback(false);} });
    cm.focus();
    
	/*if (selectionOnly.checked == false) repeatId = setTimeout(highlight, DELAY_AMOUNT * 1000);
    else */highlight();
}

function delayedRepeat() {
    if (!stopped) play.click();
}
var previousTime = 0;
function highlight() {
    if (timestamp.length == 0) {
        stop.click();
        if (repeat.checked) {
            stopped = false;
            repeatId = setTimeout(delayedRepeat, 2 * morse.getSpaceDelayInMills());
        }
        return;
    }
    
    if (previousTime != 0) addDitdah(morse._gain.gain.value > 0, parseInt((ac.currentTime - previousTime)*1000));
    previousTime = ac.currentTime;
    
    if (ac.currentTime > timestamp[0] && highlightSlowly.checked) {
        timestamp.shift();
        
        highlightStart = highlightEnd;
        cursorTempFrom.line = cursorTempTo.line, cursorTempFrom.ch = cursorTempTo.ch;
        
        if (txtValue[highlightStart] == '<' && txtValue.length > highlightStart + 3 
            && !!morse.PROSIGN[txtValue.substring(highlightStart, highlightStart + 4).toUpperCase()]) {
            highlightEnd = highlightStart + 4;
            cursorTempTo.ch = cursorTempFrom.ch + 4;
        } else if (txtValue.length > highlightStart) {
            highlightEnd = highlightStart + 1;
            if (txtValue[highlightStart] == '\n') {
                cursorTempTo.line++;
                cursorTempTo.ch = 0;
            } else {
                cursorTempTo.ch = cursorTempFrom.ch + 1;
            }
        }
    
        if (!stopped && cursorTempTo.ch != 0) {
            cm.focus();
            doc.setSelection(cursorTempFrom, cursorTempTo);
                
            if (hideText.checked) {
                setMarker(cursorTempTo, cursorTempEnd);
            }
            
            cm.refresh();
        }
    }
    
    if (!stopped) setTimeout(highlight, 7); // 7ms is based on the sampling rate
}

function setMarker(start, end) {
    clearMarker();
    marker = cm.markText(start, end, {className: "hide_markText"});
}
function clearMarker() {
    if (marker == null) return;
    
    marker.clear();
    marker = null;
}

function rollback(back) {
	if (stopped || morse == null) return;
	morse.timeMove(back ? -5 : 5);
}


var ditdah = document.querySelector("#ditdah");
var last = false, lastWidth = 0;
function addDitdah(bar, len) {
    if (bar == last && ditdah.childNodes.length > 0 && lastWidth < 8192) {
        var span = ditdah.lastChild;
        lastWidth += len;
        span.style.width = (parseInt(lastWidth) >> 3) + "px";
        return;
    }
    var span = document.createElement("SPAN");
    span.className = bar ? "ditdah_bar" : "ditdah_gap";  
    span.style.width = parseInt(len >> 3) + "px";
    ditdah.appendChild(span);
    if (ditdah.childNodes.length > 256) ditdah.removeChild(ditdah.firstChild);
    last = bar;
    lastWidth = len;
	
	if (cwPortOpen) cwPort.setSignals({dataTerminalReady:bar});
}
function clearDitdah() {
    var len = ditdah.childNodes.length;
    for (var i = 0; i < len; i++) ditdah.removeChild(ditdah.firstChild);
    
    previousTime = 0;
}

freq.onchange = function() {
    window.localStorage.setItem('freq', freq.value);
}
wpm.onchange = function() {
    window.localStorage.setItem('wpm', wpm.value);
}
//volume.onchange = function() {
//    vol = volume.value / 100.0;
//    window.localStorage.setItem('volume', volume.value);
//}
keyComputer.onchange = function() {
    window.localStorage.setItem('key', document.querySelector('input[name="key"]:checked').value);
}
/*keyElmer.onchange = function() {
    window.localStorage.setItem('key', document.querySelector('input[name="key"]:checked').value);
}
keyFarnsworth.onchange = function() {
    window.localStorage.setItem('key', document.querySelector('input[name="key"]:checked').value);
}*/
keySpace1.onchange = function() {
    window.localStorage.setItem('key', document.querySelector('input[name="key"]:checked').value);
}
keySpace2.onchange = function() {
    window.localStorage.setItem('key', document.querySelector('input[name="key"]:checked').value);
}
keySpace3.onchange = function() {
    window.localStorage.setItem('key', document.querySelector('input[name="key"]:checked').value);
}
keySpace4.onchange = function() {
    window.localStorage.setItem('key', document.querySelector('input[name="key"]:checked').value);
}
keySpace5.onchange = function() {
    window.localStorage.setItem('key', document.querySelector('input[name="key"]:checked').value);
}
/*keyStraightMed.onchange = function() {
    window.localStorage.setItem('key', document.querySelector('input[name="key"]:checked').value);
}
keyStraightBad.onchange = function() {
    window.localStorage.setItem('key', document.querySelector('input[name="key"]:checked').value);
}
keyStraightVBad.onchange = function() {
    window.localStorage.setItem('key', document.querySelector('input[name="key"]:checked').value);
}*/
flute.onchange = function() {
	smoothingDuration = flute.checked ? 0.02 : 0.004;
    window.localStorage.setItem('flute', flute.checked);
}
noise.onchange = function() {
    window.localStorage.setItem('noise', noise.checked);
}
fading.onchange = function() {
    window.localStorage.setItem('fading', fading.checked);
}
selectionOnly.onchange = function() {
    window.localStorage.setItem('selection_only', selectionOnly.checked);
}
highlightSlowly.onchange = function() {
    window.localStorage.setItem('highlight_slowly', highlightSlowly.checked);
    if (highlightSlowly.checked == false){
        document.getElementById("highlight_slowly").checked = false;
    }
}
hideText.onchange = function() {
    window.localStorage.setItem('hide_text', hideText.checked);

    if (stopped == false){  // PLAY가 진행중일때는 'PLAY할떼' 버튼이 작동하지 않도록 하기 위한 루틴
        if (hideText.checked == true){
            document.getElementById("hide_text").checked = false;
        } else {
            document.getElementById("hide_text").checked = true;
        }
    }
}
repeat.onchange = function() {
    window.localStorage.setItem('repeat', repeat.checked);
}
window.addEventListener('DOMContentLoaded', function() {
    try {
        if (window.localStorage.getItem('freq')) freq.value = parseInt(window.localStorage.getItem('freq'));
        if (window.localStorage.getItem('wpm')) wpm.value = parseInt(window.localStorage.getItem('wpm'));
        //if (window.localStorage.getItem('volume')) volume.value = parseInt(window.localStorage.getItem('volume'));
        //vol = volume.value / 100.0;
        if (window.localStorage.getItem('flute')) flute.checked = window.localStorage.getItem('flute') == 'true';
		smoothingDuration = flute.checked ? 0.02 : 0.004;
        if (window.localStorage.getItem('noise')) noise.checked = window.localStorage.getItem('noise') == 'true';
        if (window.localStorage.getItem('fading')) fading.checked = window.localStorage.getItem('fading') == 'true';
        if (window.localStorage.getItem('selection_only')) selectionOnly.checked = window.localStorage.getItem('selection_only') == 'true';
        if (window.localStorage.getItem('highlight_slowly')) highlightSlowly.checked = window.localStorage.getItem('highlight_slowly') == 'true';       
        if (window.localStorage.getItem('hide_text')) hideText.checked = window.localStorage.getItem('hide_text') == 'true';
        if (window.localStorage.getItem('repeat')) repeat.checked = window.localStorage.getItem('repeat') == 'true';
        if (window.localStorage.getItem('key')) document.querySelector('input[name="key"][value="'+window.localStorage.getItem('key')+'"]').checked = true;
        if (window.localStorage.getItem('user_txt')) userTxt.CodeMirror.doc.setValue(window.localStorage.getItem('user_txt'));
        if (window.localStorage.getItem('qso_sample')) changeQsoSample(window.localStorage.getItem('qso_sample'));
        else changeQsoSample("hangul_txt_1");
            document.getElementById("hide_now").checked = false;
            document.getElementById("hide_text").checked = true;
            document.getElementById("highlight_slowly").checked = true;
            document.getElementById("repeat").checked = false;
		if (!isAndroid && !isIOS) document.querySelector("#keyer_setting").style.display = "inline";
    } catch (e) {
    }
}, true);

function makeEditor(textArea, display) {
    var editor = CodeMirror(function(el) {
        el.id = textArea.id;
        el.className = el.className + " " + textArea.className;
        textArea.parentNode.replaceChild(el, textArea);
    }, {value: textArea.value, mode: "xml", lineWrapping: true, styleSelectedText: true
		//, extraKeys: { Left: function() {rollback(true);}, Right: function() {rollback(false);} }
	});
}

makeEditor(document.querySelector("#hangul_txt_1"));
makeEditor(document.querySelector("#user_txt"));

var txt = document.querySelector("#hangul_txt_1");
var userTxt = document.querySelector("#user_txt");

var hangulQso1 = document.querySelector("#hangul_qso_1");
var userQso = document.querySelector("#user_qso");

var SubMenu1 = document.querySelector("#sub_menu_1");
var SubMenu2 = document.querySelector("#sub_menu_2");
var SubMenu3 = document.querySelector("#sub_menu_3");
var SubMenu4 = document.querySelector("#sub_menu_4");
var SubMenu5 = document.querySelector("#sub_menu_5");
var SubMenu6 = document.querySelector("#sub_menu_6");
var SubMenu7 = document.querySelector("#sub_menu_7");
var SubMenu8 = document.querySelector("#sub_menu_8");
//var randomSB = document.querySelector("#sub_menu_4");

function changeQsoSample(newTxtId) {
    var newTxt = document.querySelector("#" + newTxtId);
    //if (txt == newTxt) return;

    var txtCaption = document.querySelector("#" + txt.id + "_caption");
    var newTxtCaption = document.querySelector("#" + newTxtId + "_caption");
    if (!txtCaption || !newTxtCaption) return;
    
    if (!stopped) stop.click();
    cursorFrom = null;
    
    txt.style.display = "none";
    txtCaption.style.display = "none";
    
    txt = newTxt;
    txtCaption = newTxtCaption;
    
    txt.style.display = "block";
    txtCaption.style.display = "block";
    
    txt.classList.toggle('active');
    cm = txt.CodeMirror;
    doc = cm.doc;
    cm.refresh();

    window.localStorage.setItem('qso_sample', newTxtId);
    window.localStorage.setItem('user_txt', userTxt.CodeMirror.doc.getValue());
}
hangulQso1.onclick = function() {
    changeQsoSample("hangul_txt_1");
}
userQso.onclick = function() {
    changeQsoSample("user_txt");
}

function getRepeatCount() {
    return parseInt(document.querySelector('input[name="repeat_count"]:checked').value);
}

//<span class="setting_bold">속도</span> <input type="number" id="speed" value="20" size="2" min="5" max="50" /> WPM

var Phrases1 = [
"DS5TUK", "DS5TUK", "DS5TUK", "DS5TUK", "DS5TUK", "DS5TUK", "DS5TUK", "DS5TUK", "DS5TUK", "DS5TUK",
"DS5TUK", "DS5TUK", "DS5TUK", "DS5TUK", "DS5TUK", "DS5TUK", "DS5TUK", "DS5TUK", "DS5TUK", "DS5TUK",
"DS5TUK", "DS5TUK", "DS5TUK", "DS5TUK", "DS5TUK", "DS5TUK", "DS5TUK", "DS5TUK", "DS5TUK", "DS5TUK",
"DS5TUK", "DS5TUK", "DS5TUK", "DS5TUK", "DS5TUK", "DS5TUK", "DS5TUK", "DS5TUK", "DS5TUK", "DS5TUK",

]

var Phrases2 = [
"DS5TUK", "DS5TUK", "DS5TUK", "DS5TUK", "DS5TUK", "DS5TUK", "DS5TUK", "DS5TUK", "DS5TUK", "DS5TUK",
"DS5NUK", "DS5NUK",
"DS5TAK", "DS5TAK",
"DH4TUK", "DH4TUK",
"DH5TUK", "DH5TUK",
"DS5TUK", "DS5TUK", "DS5TUK", "DS5TUK", "DS5TUK", "DS5TUK", "DS5TUK", "DS5TUK", "DS5TUK", "DS5TUK",
"DI5TAK", "DI5TAK",
"NS5TUK", "NS5TUK",
"DS5AUK", "DS5AUK",
"DS5TUK", "DS5TUK", "DS5TUK", "DS5TUK", "DS5TUK", "DS5TUK", "DS5TUK", "DS5TUK", "DS5TUK", "DS5TUK",
"DS5DUK", "DS5DUK",
"DS5TUN", "DS5TUN",
"DS5TUC", "DS5TUC",
"DS5TUK", "DS5TUK", "DS5TUK", "DS5TUK", "DS5TUK", "DS5TUK", "DS5TUK", "DS5TUK", "DS5TUK", "DS5TUK",
"DS3TUK", "DS3TUK",
"DS5AUK", "DS5AUK",
"NS5TVK", "NS5TVK",
"DS5TVK", "DS5TVK",
"DS5TUK", "DS5TUK", "DS5TUK", "DS5TUK", "DS5TUK", "DS5TUK", "DS5TUK", "DS5TUK", "DS5TUK", "DS5TUK",
"DH5TAK", "DH5TAK",
"DS5AVK", "DS5AVK",
"DS5TVN", "DS5TVN",
"DH5AUK", "DH5AUK",
"DS5TUK", "DS5TUK", "DS5TUK", "DS5TUK", "DS5TUK", "DS5TUK", "DS5TUK", "DS5TUK", "DS5TUK", "DS5TUK",
"DS4TVK", "DS4TVK",
"DS4TUK", "DS4TUK",
]

var Phrases3 = [
"DS5TUK", "DS5TUK", "DS5TUK", "DS5TUK", "DS5TUK", "DS5TUK", "DS5TUK", "DS5TUK", "DS5TUK", "DS5TUK",
"DS5NUK", "DS5NUK",
"DS5TAK", "DS5TAK",
"DH4TUK", "DH4TUK",
"DH5TUK", "DH5TUK",
"DI5TAK", "DI5TAK",
"NS5TUK", "NS5TUK",
"DS5AUK", "DS5AUK",
"DS5DUK", "DS5DUK",
"DS5TUN", "DS5TUN",
"DS5TUK", "DS5TUK", "DS5TUK", "DS5TUK", "DS5TUK", "DS5TUK", "DS5TUK", "DS5TUK", "DS5TUK", "DS5TUK",
"DS5TUC", "DS5TUC",
"DS3TUK", "DS3TUK",
"DS5AUK", "DS5AUK",
"NS5TVK", "NS5TVK",
"DS5TVK", "DS5TVK",
"DH5TAK", "DH5TAK",
"DS5AVK", "DS5AVK",
"DS5TUK", "DS5TUK", "DS5TUK", "DS5TUK", "DS5TUK",
"DS5TVN", "DS5TVN",
"DH5AUK", "DH5AUK",
"DS4TVK", "DS4TVK",
"DS4TUK", "DS4TUK",
]

var Phrases4 = [
"DS5TUK", "DS5TUK", "DS5TUK", "DS5TUK", "DS5TUK", "DS5TUK", "DS5TUK", "DS5TUK", "DS5TUK", "DS5TUK",
"DS5NUK", "DS5NUK",
"DS5TAK", "DS5TAK",
"DH4TUK", "DH4TUK",
"DH5TUK", "DH5TUK",
"DI5TAK", "DI5TAK",
"NS5TUK", "NS5TUK",
"DS5AUK", "DS5AUK",
"DS5DUK", "DS5DUK",
"DS5TUN", "DS5TUN",
"DS5TUK", "DS5TUK", "DS5TUK",
"DS5TUC", "DS5TUC",
"DS3TUK", "DS3TUK",
"DS5AUK", "DS5AUK",
"NS5TVK", "NS5TVK",
"DS5TVK", "DS5TVK",
"DH5TAK", "DH5TAK",
"DS5AVK", "DS5AVK",
"DS5TVN", "DS5TVN",
"DH5AUK", "DH5AUK",
"DS4TVK", "DS4TVK",
"DS4TUK", "DS4TUK",
]


var slicedPhrases = [];
var addedText;
var hideAlways = document.getElementById('hide_now');
var Callsign = [];

SubMenu1.onclick = function() {
    stop.click();

    var repeatedPhrases = [];
    var addedPhrases = [];
    repeatCount = getRepeatCount();

        Phrases1.sort(() => Math.random() - 0.5);
        Phrases1.sort(() => Math.random() - 0.5);
        Phrases1.sort(() => Math.random() - 0.5);
        Phrases1.sort(() => Math.random() - 0.5);
        Phrases1.sort(() => Math.random() - 0.5);

        for (var n = 0; n < 100; n += 5) {
            Callsign[n] = Phrases1.slice(n, n + 5);
        }

        doc.setValue(Callsign[0].join(" ") + " \n" + Callsign[5].join(" ") + " \n" + Callsign[10].join(" ")
        + " \n" + Callsign[15].join(" "));

    if (hideAlways.checked == true){
        setMarket_short_after(100);
    }
}

SubMenu2.onclick = function() {
    stop.click();

    var repeatedPhrases = [];
    var addedPhrases = [];
    repeatCount = getRepeatCount();

        Phrases1.sort(() => Math.random() - 0.5);
        Phrases1.sort(() => Math.random() - 0.5);
        Phrases1.sort(() => Math.random() - 0.5);
        Phrases1.sort(() => Math.random() - 0.5);
        Phrases1.sort(() => Math.random() - 0.5);

        for (var n = 0; n < 100; n += 5) {
            Callsign[n] = Phrases1.slice(n, n + 5);
        }

        doc.setValue(Callsign[0].join(" ") + " \n" + Callsign[5].join(" ") + " \n" + Callsign[10].join(" ")
        + " \n" + Callsign[15].join(" ") + " \n" + Callsign[20].join(" ") + " \n" + Callsign[25].join(" ")
        + " \n" + Callsign[30].join(" "));

    if (hideAlways.checked == true){
        setMarket_short_after(100);
    }
}

SubMenu3.onclick = function() {
    stop.click();

    var repeatedPhrases = [];
    var addedPhrases = [];
    repeatCount = getRepeatCount();

        Phrases2.sort(() => Math.random() - 0.5);
        Phrases2.sort(() => Math.random() - 0.5);
        Phrases2.sort(() => Math.random() - 0.5);
        Phrases2.sort(() => Math.random() - 0.5);
        Phrases2.sort(() => Math.random() - 0.5);

        for (var n = 0; n < 100; n += 5) {
            Callsign[n] = Phrases2.slice(n, n + 5);
        }

        doc.setValue(Callsign[0].join(" ") + " \n" + Callsign[5].join(" ") + " \n" + Callsign[10].join(" ")
        + " \n" + Callsign[15].join(" "));

    if (hideAlways.checked == true){
        setMarket_short_after(100);
    }

}

SubMenu4.onclick = function() {
    stop.click();

    var repeatedPhrases = [];
    var addedPhrases = [];
    repeatCount = getRepeatCount();

        Phrases2.sort(() => Math.random() - 0.5);
        Phrases2.sort(() => Math.random() - 0.5);
        Phrases2.sort(() => Math.random() - 0.5);
        Phrases2.sort(() => Math.random() - 0.5);
        Phrases2.sort(() => Math.random() - 0.5);

        for (var n = 0; n < 100; n += 5) {
            Callsign[n] = Phrases2.slice(n, n + 5);
        }

        doc.setValue(Callsign[0].join(" ") + " \n" + Callsign[5].join(" ") + " \n" + Callsign[10].join(" ")
        + " \n" + Callsign[15].join(" ") + " \n" + Callsign[20].join(" ") + " \n" + Callsign[25].join(" ")
        + " \n" + Callsign[30].join(" "));

    if (hideAlways.checked == true){
        setMarket_short_after(100);
    }
}

SubMenu5.onclick = function() {
    stop.click();

    var repeatedPhrases = [];
    var addedPhrases = [];
    repeatCount = getRepeatCount();

        Phrases3.sort(() => Math.random() - 0.5);
        Phrases3.sort(() => Math.random() - 0.5);
        Phrases3.sort(() => Math.random() - 0.5);
        Phrases3.sort(() => Math.random() - 0.5);
        Phrases3.sort(() => Math.random() - 0.5);

        for (var n = 0; n < 100; n += 5) {
            Callsign[n] = Phrases3.slice(n, n + 5);
        }

        doc.setValue(Callsign[0].join(" ") + " \n" + Callsign[5].join(" ") + " \n" + Callsign[10].join(" ")
        + " \n" + Callsign[15].join(" "));

    if (hideAlways.checked == true){
        setMarket_short_after(100);
    }

}

SubMenu6.onclick = function() {
    stop.click();

    var repeatedPhrases = [];
    var addedPhrases = [];
    repeatCount = getRepeatCount();

        Phrases3.sort(() => Math.random() - 0.5);
        Phrases3.sort(() => Math.random() - 0.5);
        Phrases3.sort(() => Math.random() - 0.5);
        Phrases3.sort(() => Math.random() - 0.5);
        Phrases3.sort(() => Math.random() - 0.5);

        for (var n = 0; n < 100; n += 5) {
            Callsign[n] = Phrases3.slice(n, n + 5);
        }

        doc.setValue(Callsign[0].join(" ") + " \n" + Callsign[5].join(" ") + " \n" + Callsign[10].join(" ")
        + " \n" + Callsign[15].join(" ") + " \n" + Callsign[20].join(" ") + " \n" + Callsign[25].join(" ")
        + " \n" + Callsign[30].join(" "));

    if (hideAlways.checked == true){
        setMarket_short_after(100);
    }
}

SubMenu7.onclick = function() {
    stop.click();

    var repeatedPhrases = [];
    var addedPhrases = [];
    repeatCount = getRepeatCount();

        Phrases4.sort(() => Math.random() - 0.5);
        Phrases4.sort(() => Math.random() - 0.5);
        Phrases4.sort(() => Math.random() - 0.5);
        Phrases4.sort(() => Math.random() - 0.5);
        Phrases4.sort(() => Math.random() - 0.5);

        for (var n = 0; n < 100; n += 5) {
            Callsign[n] = Phrases4.slice(n, n + 5);
        }

        doc.setValue(Callsign[0].join(" ") + " \n" + Callsign[5].join(" ") + " \n" + Callsign[10].join(" ")
        + " \n" + Callsign[15].join(" "));

    if (hideAlways.checked == true){
        setMarket_short_after(100);
    }

}

SubMenu8.onclick = function() {
    stop.click();

    var repeatedPhrases = [];
    var addedPhrases = [];
    repeatCount = getRepeatCount();

        Phrases4.sort(() => Math.random() - 0.5);
        Phrases4.sort(() => Math.random() - 0.5);
        Phrases4.sort(() => Math.random() - 0.5);
        Phrases4.sort(() => Math.random() - 0.5);
        Phrases4.sort(() => Math.random() - 0.5);

        for (var n = 0; n < 100; n += 5) {
            Callsign[n] = Phrases4.slice(n, n + 5);
        }

        doc.setValue(Callsign[0].join(" ") + " \n" + Callsign[5].join(" ") + " \n" + Callsign[10].join(" ")
        + " \n" + Callsign[15].join(" ") + " \n" + Callsign[20].join(" ") + " \n" + Callsign[25].join(" ")
        + " \n" + Callsign[30].join(" "));

    if (hideAlways.checked == true){
        setMarket_short_after(100);
    }
}



function onChangeHideAlways(){
    //var hideAlways = document.getElementById('hide_now');

    if (stopped == false){  // PLAY가 진행중일때는 '항상' 버튼이 작동하지 않도록 하기 위한 루틴
        if (hideAlways.checked == true){
            document.getElementById("hide_now").checked = false;
        } else {
            document.getElementById("hide_now").checked = true;
        }
    }else {
            var lastLine = doc.lastLine();
            var lastLineLength = doc.getLine(lastLine).length;
            
            cursorTempFrom = {line: 0, ch: 0};
            cursorTempTo = {line: 0, ch: 0};
            cursorTempEnd = {line: lastLine, ch: lastLineLength};

            var checkbox = document.getElementById('hide_now');
            if (checkbox.checked == true){
                document.getElementById("hide_text").checked = true;
                setMarker(cursorTempFrom, cursorTempEnd);
            } else{
                clearMarker();
            }
    }        
}

function setMarket_short_after(timeout) {
    lastLine = doc.lastLine();
    lastLineLength = doc.getLine(lastLine).length;

    cursorTempFrom = {line: 0, ch: 0};
    cursorTempTo = {line: 0, ch: 0};
    cursorTempEnd = {line: lastLine, ch: lastLineLength};

    setTimeout(function() {
        setMarker(cursorTempFrom, cursorTempEnd);
    }, timeout);
}

</script>
</html>
